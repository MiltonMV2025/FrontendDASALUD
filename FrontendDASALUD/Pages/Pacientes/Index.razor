@page "/pacientes"
@layout FrontendDASALUD.Layout.DashboardLayout
@inject FrontendDASALUD.Services.IAuthService Auth
@inject FrontendDASALUD.Services.IApiService Api
@inject NavigationManager Navigation
@inject IJSRuntime JS

@using FrontendDASALUD.Models
@using FrontendDASALUD.Components

<link href="css/citas.css" rel="stylesheet" />

<div class="header-block">
    <div class="page-header">
        <div>
            <h2 class="page-title">Pacientes Registrados</h2>
            <p class="page-subtitle">Se muestran @(_pageSize) registros por página.</p>
        </div>
        <button class="btn-primary-sm" @onclick="Create">Añadir Paciente</button>
    </div>
</div>

<div class="table-card">
    @if (_loading)
    {
        <div class="table-loading">Cargando...</div>
    }

    <div class="table-wrapper">
        <table class="appointments">
            <thead>
                <tr>
                    <th style="width:120px;">ID Paciente</th>
                    <th>Nombre completo</th>
                    <th>DUI</th>
                    <th>Teléfono</th>
                    <th>Correo</th>
                    <th>Dirección</th>
                    <th>Tipo sangre</th>
                    <th>Peso (kg)</th>
                    <th>Altura (cm)</th>
                    <th class="col-actions">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (_pacientes?.Any() == true)
                {
                    foreach (var p in _pacientes)
                    {
                        <tr id="paciente-row-@p.IdPaciente">
                            <td>@p.IdPaciente</td>
                            <td>@($"{p.Nombres} {p.Apellidos}")</td>
                            <td>@p.Dui</td>
                            <td>@p.Telefono</td>
                            <td>@p.Correo</td>
                            <td>@p.Direccion</td>
                            <td>@p.TipoSangre</td>
                            <td>@p.Peso</td>
                            <td>@p.Altura</td>
                            <td class="col-actions">
                                <div class="actions">
                                    <button class="icon-btn icon-blue" title="Editar" aria-label="Editar" @onclick="@(() => Edit(p.IdPaciente))">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 20h9"></path>
                                            <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                                        </svg>
                                    </button>

                                    <button class="icon-btn icon-red" title="Eliminar" aria-label="Eliminar" @onclick="@(async () => await ConfirmDelete(p))" disabled="@(_deletingId == p.IdPaciente)">
                                        @if (_deletingId == p.IdPaciente)
                                        {
                                            <svg width="18" height="18" viewBox="0 0 24 24">
                                                <circle cx="12" cy="12" r="10" stroke="#c0392b" stroke-width="2" fill="none" />
                                                <path d="M8 12h8" stroke="#c0392b" stroke-width="2" />
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                                                <path d="M10 11v6M14 11v6"></path>
                                                <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        }
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="10" style="padding:24px; text-align:center; color:#6E7C87;">
                            No hay registros para mostrar.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="pagination-bar">
        <span class="label">Página @(_page) de @_totalPages</span>
        <div class="pager">
            <button class="page" @onclick="@(async () => await ChangePage(_page - 1))" disabled="@(_page <= 1)">&lt;</button>
            @for (int p = 1; p <= _totalPages; p++)
            {
                var pageNum = p;
                <button class="page @(pageNum == _page ? "active" : "")" @onclick="@(async () => await ChangePage(pageNum))">@pageNum</button>
            }
            <button class="page" @onclick="@(async () => await ChangePage(_page + 1))" disabled="@(_page >= _totalPages)">&gt;</button>
        </div>
    </div>
</div>

@* Modal component instance *@
<ConfirmDeleteModal @bind-Visible="_showDeleteModal"
                    Title="¿Eliminar paciente?"
                    Message="Esta acción eliminará permanentemente el paciente seleccionado del sistema."
                    Warning="Advertencia: Esta acción no se puede deshacer."
                    ConfirmButtonText="Eliminar"
                    OnConfirm="OnConfirmDeletePaciente"
                    Details="@( _toDeletePaciente != null ? new List<ConfirmDeleteModal.ModalDetail> {
                        new ConfirmDeleteModal.ModalDetail{ Label = "ID Paciente:", Value = $"#{_toDeletePaciente.IdPaciente:D4}" },
                        new ConfirmDeleteModal.ModalDetail{ Label = "Nombre:", Value = $"{_toDeletePaciente.Nombres} {_toDeletePaciente.Apellidos}" },
                        new ConfirmDeleteModal.ModalDetail{ Label = "DUI:", Value = _toDeletePaciente.Dui }
                    } : null )">
</ConfirmDeleteModal>

@code {
    private List<PacienteDtos>? _pacientes;
    private int _page = 1;
    private int _pageSize = 10;
    private int _totalPages = 1;
    private bool _loading = false;
    private int? _deletingId = null;
    private bool _authenticated = false;

    private bool _showDeleteModal = false;
    private PacienteDtos _toDeletePaciente = null!;

    protected override async Task OnInitializedAsync()
    {
        _authenticated = await Auth.IsAuthenticatedAsync();
        if (!_authenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }
        await LoadPageAsync(_page);
    }

    private async Task LoadPageAsync(int page)
    {
        try
        {
            _loading = true;
            _page = Math.Max(1, page);
            _pageSize = 10;

            var res = await Api.GetAsync<ApiResponse<PagedResult<PacienteDtos>>>(
                $"api/pacientes?page={_page}&pageSize={_pageSize}");

            if (res?.Data?.Items != null)
            {
                _pacientes = res.Data.Items;
                _page = res.Data.Page;
                _pageSize = res.Data.PageSize;
                _totalPages = res.Data.TotalPages;
            }
            else
            {
                _pacientes = new List<PacienteDtos>();
                _totalPages = 1;
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading patients: {ex.Message}");
            _pacientes = new List<PacienteDtos>();
            _totalPages = 1;
            await JS.InvokeVoidAsync("Alerts.error", "Error", "No se pudieron cargar los pacientes.");
        }
        finally
        {
            _loading = false;
        }
    }

    private void Create() => Navigation.NavigateTo("/pacientes/create");
    private void Edit(int id) => Navigation.NavigateTo("/pacientes/edit/" + id);

    private async Task ConfirmDelete(PacienteDtos p)
    {
        _toDeletePaciente = p;
        _showDeleteModal = true;
        StateHasChanged();
    }

    private async Task OnConfirmDeletePaciente()
    {
        if (_toDeletePaciente == null) return;

        _deletingId = _toDeletePaciente.IdPaciente;
        StateHasChanged();
        await Delete(_toDeletePaciente.IdPaciente);
        _deletingId = null;
        _showDeleteModal = false;
        _toDeletePaciente = null!;
        StateHasChanged();
    }

    private async Task Delete(int id)
    {
        try
        {
            var resp = await Api.DeleteAsync("api/pacientes/" + id);
            if (resp.IsSuccessStatusCode)
            {
                _pacientes = _pacientes?.Where(x => x.IdPaciente != id).ToList();
                await JS.InvokeVoidAsync("Alerts.success", "Eliminado", "El paciente se eliminó correctamente.");
            }
            else
            {
                await JS.InvokeVoidAsync("Alerts.error", "Error", "No se pudo eliminar el paciente.");
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error deleting patient: {ex.Message}");
            await JS.InvokeVoidAsync("Alerts.error", "Error", "Ocurrió un error eliminando el paciente.");
        }
    }

    private async Task ChangePage(int p)
    {
        if (p < 1) p = 1;
        if (p > _totalPages) p = _totalPages;
        if (p == _page) return;
        await LoadPageAsync(p);
    }
}
