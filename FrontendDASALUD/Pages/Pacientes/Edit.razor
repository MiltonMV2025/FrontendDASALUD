@page "/pacientes/edit/{Id:int}"
@layout FrontendDASALUD.Layout.DashboardLayout

@using FrontendDASALUD.ViewModels
@using FrontendDASALUD.Models
@inject FrontendDASALUD.Services.IAuthService Auth
@inject FrontendDASALUD.Services.IApiService Api
@inject NavigationManager Navigation
@inject IJSRuntime JS

<link href="css/citas.css" rel="stylesheet" />

@if (!_authenticated)
{
    <div style="padding: 40px; text-align: center;">
        <h2>Acceso denegado</h2>
        <p>Debe iniciar sesión para acceder a esta sección.</p>
    </div>
}
else if (_loading || _model == null)
{
    <div class="loading-container">
        <div class="spinner-border" role="status"></div>
        <span>Cargando información del paciente...</span>
    </div>
}
else
{
    <div class="header-block">
        <div class="page-header">
            <div>
                <h2 class="page-title">Editar Paciente</h2>
                <p class="page-subtitle">Modifica los datos del paciente.</p>
            </div>
        </div>
    </div>

    <div class="citas-form-card">
        <EditForm Model="_model" OnValidSubmit="HandleEdit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Nombres</label>
                    <InputText @bind-Value="_model.Nombres" class="form-input" />
                    <ValidationMessage For="@(() => _model.Nombres)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Apellidos</label>
                    <InputText @bind-Value="_model.Apellidos" class="form-input" />
                    <ValidationMessage For="@(() => _model.Apellidos)" />
                </div>

                <div class="form-group">
                    <label class="form-label">DUI</label>
                    <InputText @bind-Value="_model.Dui" class="form-input" />
                    <ValidationMessage For="@(() => _model.Dui)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Dirección</label>
                    <InputText @bind-Value="_model.Direccion" class="form-input" />
                    <ValidationMessage For="@(() => _model.Direccion)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Correo</label>
                    <InputText @bind-Value="_model.Correo" class="form-input" />
                    <ValidationMessage For="@(() => _model.Correo)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Teléfono</label>
                    <InputText @bind-Value="_model.Telefono" class="form-input" />
                    <ValidationMessage For="@(() => _model.Telefono)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo de sangre</label>
                    <InputText @bind-Value="_model.TipoSangre" class="form-input" />
                    <ValidationMessage For="@(() => _model.TipoSangre)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Peso (kg)</label>
                    <InputNumber @bind-Value="_model.Peso" class="form-input" />
                    <ValidationMessage For="@(() => _model.Peso)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Altura (cm)</label>
                    <InputNumber @bind-Value="_model.Altura" class="form-input" />
                    <ValidationMessage For="@(() => _model.Altura)" />
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">Guardar cambios</button>
                <button type="button" class="btn-secondary" @onclick="Cancel">Cancelar</button>
            </div>
        </EditForm>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private EditPacienteViewModel? _model;
    private bool _authenticated = false;
    private bool _loading = false;

    protected override async Task OnInitializedAsync()
    {
        _authenticated = await Auth.IsAuthenticatedAsync();
        if (!_authenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _loading = true;

            // GET api/pacientes/{id} -> ApiResponse<PacienteDtos>
            var res = await Api.GetAsync<ApiResponse<PacienteDtos>>($"api/pacientes/{Id}");

            if (res?.Data != null)
            {
                var p = res.Data;

                _model = new EditPacienteViewModel
                {
                    IdPaciente = p.IdPaciente,
                    Nombres = p.Nombres,
                    Apellidos = p.Apellidos,
                    Dui = p.Dui,
                    Direccion = p.Direccion,
                    Correo = p.Correo,
                    Telefono = p.Telefono,
                    // campos nuevos (tolerando null del DTO)
                    TipoSangre = p.TipoSangre ?? string.Empty,
                    Peso = p.Peso ?? 0m,
                    Altura = p.Altura ?? 0m
                };
            }
            else
            {
                await JS.InvokeVoidAsync("Alerts.error", "Error", "Paciente no encontrado.");
                Navigation.NavigateTo("/pacientes");
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error cargando paciente: {ex}");
            await JS.InvokeVoidAsync("Alerts.error", "Error", "Ocurrió un error cargando el paciente.");
            Navigation.NavigateTo("/pacientes");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleEdit()
    {
        if (_model == null) return;

        try
        {
            var resp = await Api.PutRawAsync($"api/pacientes/{_model.IdPaciente}", _model);
            if (resp.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("Alerts.success", "Paciente actualizado", "Los datos se guardaron correctamente.");
                Navigation.NavigateTo("/pacientes");
            }
            else
            {
                await JS.InvokeVoidAsync("Alerts.error", "Error", "No se pudo actualizar el paciente.");
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error actualizando paciente: {ex}");
            await JS.InvokeVoidAsync("Alerts.error", "Error", "Ocurrió un error al actualizar el paciente.");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/pacientes");
    }
}
