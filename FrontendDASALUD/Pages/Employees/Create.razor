@page "/employees/create"
@layout FrontendDASALUD.Layout.DashboardLayout

@inject FrontendDASALUD.Services.IAuthService Auth
@inject FrontendDASALUD.Services.IApiService Api
@inject NavigationManager Navigation
@inject IJSRuntime JS

@using FrontendDASALUD.Models
@using System.ComponentModel.DataAnnotations

<link href="css/citas.css" rel="stylesheet" />

<div class="header-block">
    <div class="page-header">
        <div>
            <h2 class="page-title">Nuevo Empleado</h2>
            <p class="page-subtitle">Registra un nuevo empleado en el sistema.</p>
        </div>
    </div>
</div>

<div class="citas-form-card">
    @if (_loading)
    {
        <div style="padding:20px; text-align:center;">
            Cargando catálogos...
        </div>
    }
    else
    {
        <EditForm Model="_model" OnValidSubmit="HandleCreate">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-grid">

                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <InputText class="form-input" @bind-Value="_model.Usuario" />
                    <ValidationMessage For="() => _model.Usuario" />
                </div>

                <div class="form-group">
                    <label class="form-label">Contraseña</label>
                    <InputText class="form-input" type="password" @bind-Value="_model.Password" />
                    <ValidationMessage For="() => _model.Password" />
                </div>

                <div class="form-group">
                    <label class="form-label">Nombres</label>
                    <InputText class="form-input" @bind-Value="_model.Nombres" />
                    <ValidationMessage For="() => _model.Nombres" />
                </div>

                <div class="form-group">
                    <label class="form-label">Apellidos</label>
                    <InputText class="form-input" @bind-Value="_model.Apellidos" />
                    <ValidationMessage For="() => _model.Apellidos" />
                </div>

                <div class="form-group">
                    <label class="form-label">Correo (opcional)</label>
                    <InputText class="form-input" @bind-Value="_model.Correo" />
                </div>

                <div class="form-group">
                    <label class="form-label">DUI</label>
                    <InputText class="form-input" @bind-Value="_model.DUI" />
                    <ValidationMessage For="() => _model.DUI" />
                </div>

                <div class="form-group">
                    <label class="form-label">Teléfono</label>
                    <InputText class="form-input" @bind-Value="_model.Telefono" />
                    <ValidationMessage For="() => _model.Telefono" />
                </div>

                <div class="form-group">
                    <label class="form-label">Dirección (opcional)</label>
                    <InputText class="form-input" @bind-Value="_model.Direccion" />
                </div>

                <div class="form-group">
                    <label class="form-label">Rol</label>
                    <InputSelect class="form-select" @bind-Value="_model.IdRol">
                        <option value="0">Selecciona un rol</option>
                        @foreach (var r in _roles ?? Enumerable.Empty<SelectionItem>())
                        {
                            <option value="@r.Id">@r.Text</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => _model.IdRol" />
                </div>

                <div class="form-group">
                    <label class="form-label">Especialidad</label>
                    <InputSelect class="form-select" @bind-Value="_model.IdEspecialidad">
                        <option value="0">Selecciona una especialidad</option>
                        @foreach (var s in _especialidades ?? Enumerable.Empty<SelectionItem>())
                        {
                            <option value="@s.Id">@s.Text</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => _model.IdEspecialidad" />
                </div>

                <div class="form-group">
                    <label>
                        <InputCheckbox @bind-Value="_model.Activo" /> Activo
                    </label>
                </div>

            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="Cancel">Cancelar</button>
                <button type="submit" class="btn-primary">Crear empleado</button>
            </div>
        </EditForm>
    }
</div>

@code {
    private bool _authenticated = false;
    private bool _loading = true;

    private CreateEmpleadoModel _model = new();

    private List<SelectionItem>? _roles;
    private List<SelectionItem>? _especialidades;

    protected override async Task OnInitializedAsync()
    {
        _authenticated = await Auth.IsAuthenticatedAsync();
        if (!_authenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadSelectionsAsync();
    }

    private async Task LoadSelectionsAsync()
    {
        try
        {
            _loading = true;

            // Catálogos fijos - ajusta estos IDs según tu base de datos
            _roles = new List<SelectionItem>
            {
                new SelectionItem { Id = 1, Text = "Administrador" },
                new SelectionItem { Id = 2, Text = "Médico" },
                new SelectionItem { Id = 3, Text = "Enfermero" },
                new SelectionItem { Id = 4, Text = "Recepcionista" }
            };

            _especialidades = new List<SelectionItem>
            {
                new SelectionItem { Id = 1, Text = "Medicina General" },
                new SelectionItem { Id = 2, Text = "Pediatría" },
                new SelectionItem { Id = 3, Text = "Cardiología" },
                new SelectionItem { Id = 4, Text = "Traumatologia" },
                new SelectionItem { Id = 5, Text = "Administracion" },
            };
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading roles/especialidades: {ex.Message}");
            _roles = new List<SelectionItem>();
            _especialidades = new List<SelectionItem>();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleCreate()
    {
        var resp = await Api.PostRawAsync("api/Empleados", _model);

        if (resp.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("Alerts.success", "Empleado creado", "Registro guardado correctamente");
            Navigation.NavigateTo("/employees");
        }
        else
        {
            await JS.InvokeVoidAsync("Alerts.error", "Error", "No se pudo crear el empleado");
        }
    }

    private void Cancel() => Navigation.NavigateTo("/employees");

    public class CreateEmpleadoModel
    {
        [Required] public string Usuario { get; set; } = string.Empty;
        [Required] public string Password { get; set; } = string.Empty;
        [Required] public string Nombres { get; set; } = string.Empty;
        [Required] public string Apellidos { get; set; } = string.Empty;
        public string? Correo { get; set; }
        [Required] public string DUI { get; set; } = string.Empty;
        [Required] public string Telefono { get; set; } = string.Empty;
        public string? Direccion { get; set; }
        [Required] public int IdRol { get; set; }
        [Required] public int IdEspecialidad { get; set; }
        public bool Activo { get; set; } = true;
    }

    public class SelectionItem
    {
        public int Id { get; set; }
        public string Text { get; set; } = string.Empty;
    }
}