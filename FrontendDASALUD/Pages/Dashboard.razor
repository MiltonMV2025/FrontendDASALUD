@page "/dashboard"
@layout FrontendDASALUD.Layout.DashboardLayout
@inject FrontendDASALUD.Services.IAuthService Auth
@inject FrontendDASALUD.Services.IApiService Api
@inject IJSRuntime JS
@using System.Globalization

<link href="css/dashboard.css" rel="stylesheet" />

@if (!_authenticated)
{
    <div style="padding:40px; text-align:center;">
        <h2>Acceso Denegado</h2>
        <p>Debe iniciar sesión para acceder al panel.</p>
    </div>
}
else if (_loading)
{
    <div style="padding:40px; text-align:center;">Cargando datos del sistema...</div>
}
else if (_summary is null)
{
    <div style="padding:40px; text-align:center;">No se pudo cargar el resumen. Intente nuevamente.</div>
}
else
{
    <div class="cards-grid">
        <div class="stat-card">
            <h1 class="stat-number">@_summary.PacientesAtendidos</h1>
            <p class="stat-label">Pacientes Atendidos</p>
        </div>

        <div class="stat-card">
            <h1 class="stat-number">@_summary.ConsultasPendientes</h1>
            <p class="stat-label">Consultas Pendientes</p>
        </div>

        <div class="stat-card">
            <h1 class="stat-number">@_summary.TotalIngresos.ToString("C", new CultureInfo("es-SV"))</h1>
            <p class="stat-label">Ingresos Totales (Completados)</p>
        </div>
    </div>

    <div class="cards-grid">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Total de consultas atendidas</h3>
                <p class="chart-subtitle">Proporción de consultas activas en el sistema.</p>
            </div>
            <div class="doughnut-container">
                <canvas id="totalConsultasChart"></canvas>
                <div class="doughnut-center">
                    <h2 class="doughnut-number">@_summary.TotalConsultas</h2>
                    <p class="doughnut-label">Consultas</p>
                </div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Tendencia de Consultas por Fecha</h3>
                <p class="chart-subtitle">Volumen de atención médica en los últimos 6 meses.</p>
            </div>
            <div class="chart-container">
                <canvas id="consultasPorFechaChart"></canvas>
            </div>
        </div>
    </div>

    <div class="cards-grid">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Concurrencia por Especialidad</h3>
                <p class="chart-subtitle">Comparativa mensual de demanda entre especialidades.</p>
            </div>
            <div class="chart-container">
                <canvas id="concurrenciaChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Top Especialidades</h3>
                <p class="chart-subtitle">Distribución total acumulada por área médica.</p>
            </div>
            <div class="chart-container">
                <canvas id="consultasPorEspecialidadChart"></canvas>
            </div>
        </div>
    </div>
}

@code {
    private bool _authenticated;
    private bool _loading = true;
    private DashboardSummaryDto? _summary;
    private bool _chartsRendered = false;

    protected override async Task OnInitializedAsync()
    {
        _authenticated = await Auth.IsAuthenticatedAsync();
        if (!_authenticated) return;

        try
        {
            var resp = await Api.GetAsync<ApiResponse<DashboardSummaryDto>>("api/Dashboard/summary");
            _summary = resp?.Data;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine("Error cargando dashboard: " + ex.Message);
        }
        finally
        {
            _loading = false;
            // Forzamos renderizado para que aparezca el HTML antes de pintar gráficas
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Solo renderizamos gráficas si tenemos datos y NO se han renderizado aún
        if (!_chartsRendered && _authenticated && !_loading && _summary != null)
        {
            // 1. Gráfica DONA (Total)
            // Pasamos el total como valor y el mismo total como 'meta' para que se vea llena o proporcional
            await JS.InvokeVoidAsync("DashboardCharts.renderDoughnut", "totalConsultasChart", _summary.TotalConsultas, _summary.TotalConsultas);

            // 2. Gráfica BARRAS (Tendencia Mensual)
            var meses = _summary.ConsultasPorMes.Select(x => x.Mes).ToArray();
            var cantidadesMes = _summary.ConsultasPorMes.Select(x => x.Cantidad).ToArray();
            await JS.InvokeVoidAsync("DashboardCharts.renderBar", "consultasPorFechaChart", meses, cantidadesMes);

            // 3. Gráfica LÍNEAS (Concurrencia - DATOS REALES)
            // Generamos las etiquetas de los meses dinámicamente para que coincidan con el Backend
            var culture = new CultureInfo("es-ES");
            var labelsMeses = Enumerable.Range(0, 6)
                .Select(i => DateTime.Now.AddMonths(-5 + i).ToString("MMM", culture))
                .ToArray();

            // Transformamos la data compleja para que JS la entienda
            var datasetsConcurrencia = _summary.DataConcurrencia.Select(d => new
            {
                label = d.Especialidad,
                data = d.Data,
                color = d.Color
            }).ToArray();

            await JS.InvokeVoidAsync("DashboardCharts.renderLineMulti", "concurrenciaChart", labelsMeses, datasetsConcurrencia);

            var codigosEsp = _summary.ConsultasPorEspecialidad.Select(x => x.Codigo).ToArray();
            var cantidadesEsp = _summary.ConsultasPorEspecialidad.Select(x => x.Cantidad).ToArray();
            await JS.InvokeVoidAsync("DashboardCharts.renderBar", "consultasPorEspecialidadChart", codigosEsp, cantidadesEsp);

            _chartsRendered = true;
        }
    }
}